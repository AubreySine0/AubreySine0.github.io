<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Segment Analytics Ready Test Site</title>
  
  <!-- Your existing OneTrust setup -->
  <script
    src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"
    type="text/javascript"
    charset="UTF-8"
    data-domain-script="01929b9b-c505-7cd6-9ca1-67e5e5aa979e"
  ></script>
  <script type="text/javascript">
    function OptanonWrapper() {}
  </script>

  <!-- Segment Analytics setup with controlled page call -->
  <script>
  !function(){var i="analytics",analytics=window[i]=window[i]||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","screen","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware","register"];analytics.factory=function(e){return function(){if(window[i].initialized)return window[i][e].apply(window[i],arguments);var n=Array.prototype.slice.call(arguments);if(["track","screen","alias","group","page","identify"].indexOf(e)>-1){var c=document.querySelector("link[rel='canonical']");n.push({__t:"bpc",c:c&&c.getAttribute("href")||void 0,p:location.pathname,u:location.href,s:location.search,t:document.title,r:document.referrer})}n.unshift(e);analytics.push(n);return analytics}};for(var n=0;n<analytics.methods.length;n++){var key=analytics.methods[n];analytics[key]=analytics.factory(key)}analytics.load=function(key,n){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.setAttribute("data-global-segment-analytics-key",i);t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r);analytics._loadOptions=n};analytics._writeKey="gmILwcgOaqputqVmLZKtD0eazHCAeNhR";;analytics.SNIPPET_VERSION="5.2.0";
  
  // Load analytics but DON'T call page() yet
  analytics.load("gmILwcgOaqputqVmLZKtD0eazHCAeNhR");
  
  // Use analytics.ready() to ensure all SDKs are bundled before first page call
  analytics.ready(function() {
    console.log('🚀 Analytics.js and all destination SDKs are ready!');
    console.log('📊 Loaded integrations:', Object.keys(analytics._integrations || {}));
    
    // Register plugins first
    registerPlugins().then(function() {
      console.log('🔌 Plugins registered successfully');
      
      // Now send the first page call - all SDKs are guaranteed to be loaded
      analytics.page();
      console.log('📄 First page call sent after all SDKs loaded');
      
      // Update UI to show ready status
      updateReadyStatus();
    }).catch(function(error) {
      console.error('❌ Plugin registration failed:', error);
      // Send page call anyway
      analytics.page();
      updateReadyStatus();
    });
  });
  }}();
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #007cba;
    }
    
    .section h3 {
      margin-top: 0;
      color: #333;
    }
    
    button {
      background: #007cba;
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 5px 10px 5px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #0056a3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .form-group {
      margin: 10px 0;
    }
    
    input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
      width: 200px;
    }
    
    .debug-info {
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }

    .loading-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007cba;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 Segment Analytics Ready Test</h1>
    <p class="subtitle">Using analytics.ready() to ensure all SDKs load before the first page call</p>
    
    <!-- Ready Status Section -->
    <div class="section">
      <h3>📊 Analytics Ready Status</h3>
      <div id="ready-status" class="status info">
        <div class="loading-indicator"></div>
        Waiting for Analytics.js and all destination SDKs to load...
      </div>
      <button onclick="checkReadyStatus()">Check Status</button>
      <button onclick="sendManualPageCall()">Send Manual Page Call</button>
    </div>

    <!-- Plugin Status Section -->
    <div class="section">
      <h3>🔌 Plugin Status</h3>
      <div id="plugin-status" class="status info">
        Waiting for plugins to register...
      </div>
      <button onclick="checkPluginStatus()">Check Plugins</button>
    </div>

    <!-- Event Testing Section -->
    <div class="section">
      <h3>📊 Send Test Events</h3>
      <p>All events sent after analytics.ready() fires:</p>
      
      <div class="form-group">
        <input type="text" id="track-event" placeholder="Event name" value="Button Clicked">
        <button onclick="sendTrackEvent()">Send Track Event</button>
      </div>
      
      <div class="form-group">
        <input type="text" id="user-id" placeholder="User ID" value="test-user-123">
        <input type="text" id="user-email" placeholder="Email" value="test@example.com">
        <button onclick="sendIdentifyEvent()">Send Identify Event</button>
      </div>
      
      <div class="form-group">
        <input type="text" id="page-name" placeholder="Page name" value="Test Page">
        <button onclick="sendPageEvent()">Send Page Event</button>
      </div>
      
      <div id="event-status" class="status" style="display: none;"></div>
    </div>

    <!-- Debug Information -->
    <div class="section">
      <h3>🔧 Debug Information</h3>
      <button onclick="showDebugInfo()">Show Debug Info</button>
      <button onclick="showIntegrations()">Show Loaded Integrations</button>
      <button onclick="checkNetworkRequests()">Check Network Requests</button>
      <button onclick="testSessionId()">Check Amplitude Session ID</button>
      <button onclick="openSegmentDebugger()">Open Segment Debugger</button>
      
      <div id="debug-info" class="debug-info" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Simple state tracking
    let analyticsReady = false;
    let pluginsRegistered = false;
    
    // Plugin definitions (same as before)
    window.utmCampaignPersistencePlugin = () => {
      const STORAGE_KEY = 'segment_utm_campaign_source';
      const EXPIRY_DAYS = 30;
      
      const setLocalStorageWithExpiry = (key, value, days) => {
        try {
          const now = new Date();
          const item = {
            value: value,
            expiry: now.getTime() + (days * 24 * 60 * 60 * 1000),
          };
          localStorage.setItem(key, JSON.stringify(item));
        } catch (e) {
          console.warn('UTM Plugin: localStorage not available');
        }
      };
      
      const getLocalStorageWithExpiry = (key) => {
        try {
          const itemStr = localStorage.getItem(key);
          if (!itemStr) return null;
          
          const item = JSON.parse(itemStr);
          const now = new Date();
          
          if (now.getTime() > item.expiry) {
            localStorage.removeItem(key);
            return null;
          }
          
          return item.value;
        } catch (e) {
          return null;
        }
      };
      
      return {
        name: 'UTM Campaign Source Persistence',
        type: 'enrichment',
        version: '1.0.0',
        isLoaded: () => true,
        load: () => Promise.resolve(),
        
        page: (ctx) => {
          const currentCampaignSource = ctx.event.context?.campaign?.source;
          
          if (currentCampaignSource) {
            console.log(`UTM Plugin: Found campaign source: ${currentCampaignSource}`);
            setLocalStorageWithExpiry(STORAGE_KEY, currentCampaignSource, EXPIRY_DAYS);
          } else {
            const storedCampaignSource = getLocalStorageWithExpiry(STORAGE_KEY);
            if (storedCampaignSource) {
              console.log(`UTM Plugin: Adding stored campaign source: ${storedCampaignSource}`);
              ctx.updateEvent('context.campaign.source', storedCampaignSource);
            }
          }
          
          return ctx;
        },
        
        track: (ctx) => {
          const storedCampaignSource = getLocalStorageWithExpiry(STORAGE_KEY);
          if (storedCampaignSource && !ctx.event.context?.campaign?.source) {
            ctx.updateEvent('context.campaign.source', storedCampaignSource);
          }
          return ctx;
        },
        
        identify: (ctx) => {
          const storedCampaignSource = getLocalStorageWithExpiry(STORAGE_KEY);
          if (storedCampaignSource && !ctx.event.context?.campaign?.source) {
            ctx.updateEvent('context.campaign.source', storedCampaignSource);
          }
          return ctx;
        }
      };
    };

    window.geoLocationPlugin = (options = {}) => {
      const config = {
        timeout: options.timeout || 10000,
        debug: options.debug || false,
        autoRequestPermission: options.autoRequestPermission !== false
      };

      let locationData = null;

      const getIPLocationData = async () => {
        try {
          const response = await fetch('https://ipapi.co/json/');
          const data = await response.json();
          if (data.latitude && data.longitude) {
            return {
              latitude: parseFloat(data.latitude),
              longitude: parseFloat(data.longitude),
              city: data.city,
              region: data.region,
              country: data.country_name,
              source: 'ip'
            };
          }
        } catch (error) {
          console.warn('IP location failed', error);
        }
        return null;
      };

      const enrichEventWithLocation = (ctx) => {
        if (!locationData) return ctx;
        
        ctx.updateEvent('context.location', {
          latitude: locationData.latitude?.toString(),
          longitude: locationData.longitude?.toString(),
          city: locationData.city,
          region: locationData.region,
          country: locationData.country
        });
        
        return ctx;
      };

      return {
        name: 'Geo Location Tracking',
        type: 'enrichment',
        version: '1.0.0',
        
        isLoaded: () => true,
        
        load: async () => {
          if (config.autoRequestPermission) {
            locationData = await getIPLocationData();
          }
        },

        page: (ctx) => enrichEventWithLocation(ctx),
        track: (ctx) => enrichEventWithLocation(ctx),
        identify: (ctx) => enrichEventWithLocation(ctx)
      };
    };

    // Session ID Plugin - Retrieves analytics_session_id from Amplitude's localStorage
    window.sessionIdPlugin = () => {
      const AMPLITUDE_SESSION_KEY = 'analytics_session_id';
      
      const getAmplitudeSessionId = () => {
        try {
          // Try to get Amplitude's session ID directly
          const amplitudeSessionId = localStorage.getItem(AMPLITUDE_SESSION_KEY);
          
          if (amplitudeSessionId) {
            console.log('📊 Found Amplitude session ID:', amplitudeSessionId);
            return amplitudeSessionId;
          }
          
          // If no Amplitude session ID exists yet, return null
          // (Amplitude will create one after it loads)
          console.log('⏳ No Amplitude session ID found yet - will be available after Amplitude loads');
          return null;
          
        } catch (error) {
          console.warn('Session ID Plugin: Error accessing localStorage', error);
          return null;
        }
      };
      
      const addSessionIdToEvent = (ctx) => {
        const sessionId = getAmplitudeSessionId();
        
        if (sessionId) {
          // Add to both properties and context for maximum compatibility
          ctx.updateEvent('properties.analytics_session_id', sessionId);
          ctx.updateEvent('context.sessionId', sessionId);
          console.log('✅ Added Amplitude session ID to event:', sessionId);
        } else {
          console.log('⏳ Amplitude session ID not yet available - skipping for this event');
        }
        
        return ctx;
      };
      
      return {
        name: 'Amplitude Session ID Retriever',
        type: 'enrichment',
        version: '1.0.0',
        isLoaded: () => true,
        load: () => {
          console.log('🔌 Session ID plugin loaded - will retrieve Amplitude session IDs');
          return Promise.resolve();
        },
        
        page: (ctx) => addSessionIdToEvent(ctx),
        track: (ctx) => addSessionIdToEvent(ctx),
        identify: (ctx) => addSessionIdToEvent(ctx),
        group: (ctx) => addSessionIdToEvent(ctx),
        alias: (ctx) => addSessionIdToEvent(ctx)
      };
    };
    
    // Register plugins function (called from analytics.ready)
    async function registerPlugins() {
      try {
        // Register UTM Plugin
        await window.analytics.register(window.utmCampaignPersistencePlugin());
        console.log('✅ UTM Campaign Plugin registered');
        
        // Register Geo Plugin
        await window.analytics.register(window.geoLocationPlugin({ 
          debug: true,
          autoRequestPermission: true
        }));
        console.log('✅ Geo Location Plugin registered');
        
        // Register Session ID Plugin
        await window.analytics.register(window.sessionIdPlugin());
        console.log('✅ Session ID Plugin registered');
        
        pluginsRegistered = true;
        return true;
        
      } catch (error) {
        console.error('❌ Plugin registration failed:', error);
        throw error;
      }
    }
    
    // Update ready status in UI
    function updateReadyStatus() {
      analyticsReady = true;
      const statusEl = document.getElementById('ready-status');
      
      // Check multiple sources for integration count
      const _integrations = Object.keys(window.analytics._integrations || {});
      const settingsIntegrations = window.analytics.settings?.cdnSettings?.integrations || {};
      const configuredCount = Object.keys(settingsIntegrations).length;
      const loadedCount = _integrations.length;
      
      console.log('📊 Integration Status:');
      console.log('  - Configured in settings:', configuredCount);
      console.log('  - Loaded as SDKs:', loadedCount);
      console.log('  - Settings integrations:', Object.keys(settingsIntegrations));
      console.log('  - Loaded SDK integrations:', _integrations);
      
      statusEl.className = 'status success';
      statusEl.innerHTML = `✅ Analytics ready! ${configuredCount} configured integrations, ${loadedCount} loaded SDKs`;
    }
    
    // UI Event Handlers
    function checkReadyStatus() {
      const statusEl = document.getElementById('ready-status');
      
      if (window.analytics.initialized) {
        const _integrations = Object.keys(window.analytics._integrations || {});
        const settingsIntegrations = window.analytics.settings?.cdnSettings?.integrations || {};
        const configuredCount = Object.keys(settingsIntegrations).length;
        const loadedCount = _integrations.length;
        
        statusEl.className = 'status success';
        statusEl.innerHTML = `✅ Analytics initialized: ${configuredCount} configured, ${loadedCount} SDKs loaded`;
      } else {
        statusEl.className = 'status warning';
        statusEl.innerHTML = '⏳ Still loading...';
      }
    }
    
    function checkPluginStatus() {
      const statusEl = document.getElementById('plugin-status');
      
      if (pluginsRegistered) {
        statusEl.className = 'status success';
        statusEl.innerHTML = '✅ All plugins registered successfully';
      } else if (analyticsReady) {
        statusEl.className = 'status warning';
        statusEl.innerHTML = '⏳ Analytics ready, plugins registering...';
      } else {
        statusEl.className = 'status info';
        statusEl.innerHTML = '⏳ Waiting for analytics to be ready...';
      }
    }
    
    function sendManualPageCall() {
      window.analytics.page('Manual Page Call', {
        manual: true,
        timestamp: new Date().toISOString()
      });
      updateStatus('ready-status', 'success', '📄 Manual page call sent');
    }
    
    function sendTrackEvent() {
      const eventName = document.getElementById('track-event').value || 'Button Clicked';
      window.analytics.track(eventName, {
        buttonId: 'test-button',
        timestamp: new Date().toISOString()
      });
      
      updateStatus('event-status', 'success', `✅ Sent track event: ${eventName}`);
    }
    
    function sendIdentifyEvent() {
      const userId = document.getElementById('user-id').value || 'test-user-123';
      const email = document.getElementById('user-email').value || 'test@example.com';
      
      window.analytics.identify(userId, {
        email: email,
        name: 'Test User',
        testTimestamp: new Date().toISOString()
      });
      
      updateStatus('event-status', 'success', `✅ Sent identify event for user: ${userId}`);
    }
    
    function sendPageEvent() {
      const pageName = document.getElementById('page-name').value || 'Test Page';
      window.analytics.page(pageName, {
        title: pageName,
        testTimestamp: new Date().toISOString()
      });
      
      updateStatus('event-status', 'success', `✅ Sent page event: ${pageName}`);
    }
    
    function showDebugInfo() {
      console.log('=== SEGMENT DEBUG INFO ===');
      console.log('window.analytics:', window.analytics);
      console.log('analytics.settings:', window.analytics.settings);
      console.log('cdnSettings:', window.analytics.settings?.cdnSettings);
      console.log('cdnSettings.integrations:', window.analytics.settings?.cdnSettings?.integrations);
      console.log('analytics._integrations:', window.analytics._integrations);
      
      const debugInfo = {
        // Basic status
        analyticsInitialized: window.analytics.initialized,
        analyticsReady: analyticsReady,
        pluginsRegistered: pluginsRegistered,
        
        // Settings and CDN configuration
        settings: window.analytics.settings || null,
        cdnSettings: window.analytics.settings?.cdnSettings || null,
        configuredIntegrations: window.analytics.settings?.cdnSettings?.integrations || {},
        
        // Runtime integrations
        _integrations: window.analytics._integrations || {},
        analyticsInstance: window.analytics.Analytics?.instance || null,
        instanceIntegrations: window.analytics.Analytics?.instance?.integrations || {},
        
        // Config
        writeKey: window.analytics._writeKey || null,
        
        // Browser info
        userAgent: navigator.userAgent,
        currentUrl: window.location.href,
        timestamp: new Date().toISOString()
      };
      
      const element = document.getElementById('debug-info');
      element.innerHTML = '<pre>' + JSON.stringify(debugInfo, null, 2) + '</pre>';
      element.style.display = 'block';
    }
    
    function showIntegrations() {
      console.log('=== INTEGRATION DETECTION ===');
      console.log('analytics.settings:', window.analytics.settings);
      
      // Check CDN settings for configured integrations
      const cdnSettings = window.analytics.settings?.cdnSettings || {};
      const configuredIntegrations = cdnSettings.integrations || {};
      
      // Check runtime loaded integrations
      const integrationSources = {
        'CDN Settings (Configured)': configuredIntegrations,
        '_integrations (Runtime/Loaded)': window.analytics._integrations || {},
        'Analytics.instance.integrations': window.analytics.Analytics?.instance?.integrations || {}
      };
      
      console.log('Integration sources:', integrationSources);
      
      const element = document.getElementById('debug-info');
      let html = '<h4>🔍 Integration Detection Results:</h4>';
      
      // Show configured vs loaded
      const configuredCount = Object.keys(configuredIntegrations).length;
      const loadedCount = Object.keys(window.analytics._integrations || {}).length;
      
      html += `<div class="status ${configuredCount > 0 ? 'success' : 'warning'}">`;
      html += `<strong>📋 Configured Integrations:</strong> ${configuredCount}<br>`;
      html += `<strong>🚀 Loaded SDK Integrations:</strong> ${loadedCount}`;
      html += `</div>`;
      
      // Show each source
      Object.entries(integrationSources).forEach(([source, integrations]) => {
        const count = Object.keys(integrations).length;
        html += `<h5>${source}: (${count})</h5>`;
        
        if (count > 0) {
          html += '<ul>';
          Object.entries(integrations).forEach(([name, integration]) => {
            html += `<li><strong>${name}</strong>`;
            
            // For CDN settings, show if it's enabled
            if (source.includes('CDN Settings') && typeof integration === 'object') {
              const enabled = integration.enabled !== false;
              html += ` - Enabled: ${enabled}`;
              if (integration.bundlingStatus) html += ` - Status: ${integration.bundlingStatus}`;
            }
            
            // For runtime integrations, show ready status
            if (source.includes('Runtime') || source.includes('instance')) {
              if (integration.ready !== undefined) html += ` - Ready: ${integration.ready}`;
              if (integration.loaded !== undefined) html += ` - Loaded: ${integration.loaded}`;
              if (integration.name) html += ` - Name: ${integration.name}`;
            }
            
            html += '</li>';
          });
          html += '</ul>';
        } else {
          html += '<p><em>None found</em></p>';
        }
      });
      
      // Explanation section
      if (configuredCount === 0) {
        html += '<div class="status warning">';
        html += '<h4>⚠️ No Integrations Configured</h4>';
        html += '<p>No destinations found in <code>cdnSettings.integrations</code></p>';
        html += '<p>This means no destinations are set up in your Segment workspace for this source.</p>';
        html += '</div>';
      } else if (loadedCount === 0) {
        html += '<div class="status info">';
        html += '<h4>📡 Integrations Configured but No SDKs Loaded</h4>';
        html += '<p>This usually means:</p>';
        html += '<ul>';
        html += '<li><strong>Cloud-mode destinations:</strong> Data sent server-side, no client SDK needed</li>';
        html += '<li><strong>Device-mode destinations:</strong> SDKs should load but may be blocked</li>';
        html += '</ul>';
        html += '<p>Check the Network tab to see if destination SDKs are being requested.</p>';
        html += '</div>';
      } else {
        html += '<div class="status success">';
        html += '<h4>✅ Integrations Working</h4>';
        html += `<p>${configuredCount} configured destinations, ${loadedCount} client-side SDKs loaded!</p>`;
        html += '</div>';
      }
      
      element.innerHTML = html;
      element.style.display = 'block';
    }
    
    function openSegmentDebugger() {
      const writeKey = 'gmILwcgOaqputqVmLZKtD0eazHCAeNhR';
      window.open(`https://app.segment.com/sources/${writeKey}/debugger`, '_blank');
    }
    
    function checkNetworkRequests() {
      const element = document.getElementById('debug-info');
      element.innerHTML = `
        <h4>🌐 Network Request Check:</h4>
        <ol>
          <li>Open browser DevTools (F12)</li>
          <li>Go to the <strong>Network</strong> tab</li>
          <li>Filter by "JS" or search for destination names like:
            <ul>
              <li>"amplitude" - Amplitude SDK</li>
              <li>"gtag" or "analytics" - Google Analytics</li>
              <li>"connect.facebook" - Facebook Pixel</li>
              <li>"mixpanel" - Mixpanel SDK</li>
            </ul>
          </li>
          <li>Refresh the page and look for:</li>
          <ul>
            <li>✅ <strong>Success (200)</strong> - SDK loaded properly</li>
            <li>❌ <strong>Failed/Blocked</strong> - Ad blocker or network issue</li>
            <li>⚠️ <strong>404 Not Found</strong> - Destination not configured</li>
          </ul>
        </ol>
        <p><strong>If you see failed requests:</strong> This explains why 0 SDKs are loaded!</p>
      `;
      element.style.display = 'block';
    }
    
    function testSessionId() {
      // Test the session ID plugin by showing current Amplitude session
      try {
        const amplitudeSessionId = localStorage.getItem('analytics_session_id');
        
        let sessionInfo = '';
        if (amplitudeSessionId) {
          sessionInfo = `
            <div class="status success">
              ✅ <strong>Amplitude Session ID Found:</strong><br>
              <code>${amplitudeSessionId}</code>
            </div>
          `;
        } else {
          sessionInfo = `
            <div class="status warning">
              ⚠️ <strong>No Amplitude Session ID Found</strong><br>
              This could mean:
              <ul>
                <li>Amplitude hasn't loaded yet</li>
                <li>No Amplitude events have been sent yet</li>  
                <li>Amplitude isn't configured in your Segment workspace</li>
              </ul>
            </div>
          `;
        }
        
        // Also check for other Amplitude keys that might exist
        const otherAmplitudeKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes('amplitude') || key.includes('AMP_'))) {
            otherAmplitudeKeys.push(key);
          }
        }
        
        let otherKeysInfo = '';
        if (otherAmplitudeKeys.length > 0) {
          otherKeysInfo = `
            <h5>📋 Other Amplitude Keys Found:</h5>
            <ul>
              ${otherAmplitudeKeys.map(key => {
                const value = localStorage.getItem(key);
                return `<li><strong>${key}:</strong> ${value?.substring(0, 100)}${value?.length > 100 ? '...' : ''}</li>`;
              }).join('')}
            </ul>
          `;
        }
        
        const element = document.getElementById('debug-info');
        element.innerHTML = `
          <h4>🔐 Amplitude Session ID Status:</h4>
          ${sessionInfo}
          ${otherKeysInfo}
          <p><strong>Note:</strong> The plugin will automatically add the Amplitude session ID to all events when available.</p>
          <button onclick="sendTestEventWithSession()">Send Test Event</button>
          <button onclick="refreshSessionCheck()">Refresh Check</button>
        `;
        element.style.display = 'block';
        
      } catch (error) {
        console.error('Session ID test failed:', error);
        updateStatus('debug-info', 'error', '❌ Error checking session ID: ' + error.message);
      }
    }
    
    function sendTestEventWithSession() {
      // Send a test track event to see if session ID gets added
      const sessionId = localStorage.getItem('analytics_session_id');
      console.log('🧪 Sending test event. Amplitude session ID available:', sessionId);
      
      window.analytics.track('Test Session ID Event', {
        testType: 'session_id_test',
        amplitudeSessionAvailable: !!sessionId,
        timestamp: new Date().toISOString()
      });
      
      updateStatus('debug-info', 'success', '✅ Test event sent! Check Segment debugger to see if session ID was added.');
    }
    
    function refreshSessionCheck() {
      testSessionId();
    }
    
    function clearSession() {
      // Clear the Amplitude session ID (this will force Amplitude to create a new one)
      localStorage.removeItem('analytics_session_id');
      
      // Also clear other common Amplitude keys
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('amplitude') || key.includes('AMP_'))) {
          keysToRemove.push(key);
        }
      }
      
      keysToRemove.forEach(key => {
        localStorage.removeItem(key);
        console.log('🗑️ Cleared Amplitude key:', key);
      });
      
      updateStatus('debug-info', 'success', '🔄 Amplitude session data cleared! Amplitude will create a new session on next event.');
      
      // Refresh the session check display
      setTimeout(testSessionId, 500);
    }
    
    // Utility function to update status elements
    function updateStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.className = `status ${type}`;
        element.innerHTML = message;
        element.style.display = 'block';
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
          setTimeout(() => {
            element.style.display = 'none';
          }, 5000);
        }
      }
    }
  </script>
</body>
</html>
