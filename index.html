<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Segment Analytics Ready Test Site</title>
  
  <!-- Your existing OneTrust setup -->
  <script
    src="https://cdn.cookielaw.org/scripttemplates/otSDKStub.js"
    type="text/javascript"
    charset="UTF-8"
    data-domain-script="01929b9b-c505-7cd6-9ca1-67e5e5aa979e"
  ></script>
  <script type="text/javascript">
    function OptanonWrapper() {}
  </script>

  <!-- Segment Analytics setup with controlled page call -->
  <script>
  !function(){var i="analytics",analytics=window[i]=window[i]||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","screen","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware","register"];analytics.factory=function(e){return function(){if(window[i].initialized)return window[i][e].apply(window[i],arguments);var n=Array.prototype.slice.call(arguments);if(["track","screen","alias","group","page","identify"].indexOf(e)>-1){var c=document.querySelector("link[rel='canonical']");n.push({__t:"bpc",c:c&&c.getAttribute("href")||void 0,p:location.pathname,u:location.href,s:location.search,t:document.title,r:document.referrer})}n.unshift(e);analytics.push(n);return analytics}};for(var n=0;n<analytics.methods.length;n++){var key=analytics.methods[n];analytics[key]=analytics.factory(key)}analytics.load=function(key,n){var t=document.createElement("script");t.type="text/javascript";t.async=!0;t.setAttribute("data-global-segment-analytics-key",i);t.src="https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(t,r);analytics._loadOptions=n};analytics._writeKey="gmILwcgOaqputqVmLZKtD0eazHCAeNhR";;analytics.SNIPPET_VERSION="5.2.0";
  
  // Load analytics but DON'T call page() yet
  analytics.load("gmILwcgOaqputqVmLZKtD0eazHCAeNhR");
  
  // Use analytics.ready() to ensure all SDKs are bundled before first page call
  analytics.ready(function() {
    console.log('🚀 Analytics.js and all destination SDKs are ready!');
    console.log('📊 Loaded integrations:', Object.keys(analytics._integrations || {}));
    
    // Register plugins first
    registerPlugins().then(function() {
      console.log('🔌 Plugins registered successfully');
      
      // Now send the first page call - all SDKs are guaranteed to be loaded
      analytics.page();
      console.log('📄 First page call sent after all SDKs loaded');
      
      // Update UI to show ready status
      updateReadyStatus();
    }).catch(function(error) {
      console.error('❌ Plugin registration failed:', error);
      // Send page call anyway
      analytics.page();
      updateReadyStatus();
    });
  });
  }}();
  </script>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      line-height: 1.6;
      background: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #007cba;
    }
    
    .section h3 {
      margin-top: 0;
      color: #333;
    }
    
    button {
      background: #007cba;
      color: white;
      border: none;
      padding: 12px 20px;
      margin: 5px 10px 5px 0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    button:hover {
      background: #0056a3;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .form-group {
      margin: 10px 0;
    }
    
    input {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-right: 10px;
      width: 200px;
    }
    
    .debug-info {
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }

    .loading-indicator {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #007cba;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 Segment Analytics Ready Test</h1>
    <p class="subtitle">Using analytics.ready() to ensure all SDKs load before the first page call</p>
    
    <!-- Ready Status Section -->
    <div class="section">
      <h3>📊 Analytics Ready Status</h3>
      <div id="ready-status" class="status info">
        <div class="loading-indicator"></div>
        Waiting for Analytics.js and all destination SDKs to load...
      </div>
      <button onclick="checkReadyStatus()">Check Status</button>
      <button onclick="sendManualPageCall()">Send Manual Page Call</button>
    </div>

    <!-- Plugin Status Section -->
    <div class="section">
      <h3>🔌 Plugin Status</h3>
      <div id="plugin-status" class="status info">
        Waiting for plugins to register...
      </div>
      <button onclick="checkPluginStatus()">Check Plugins</button>
    </div>

    <!-- Event Testing Section -->
    <div class="section">
      <h3>📊 Send Test Events</h3>
      <p>All events sent after analytics.ready() fires:</p>
      
      <div class="form-group">
        <input type="text" id="track-event" placeholder="Event name" value="Button Clicked">
        <button onclick="sendTrackEvent()">Send Track Event</button>
      </div>
      
      <div class="form-group">
        <input type="text" id="user-id" placeholder="User ID" value="test-user-123">
        <input type="text" id="user-email" placeholder="Email" value="test@example.com">
        <button onclick="sendIdentifyEvent()">Send Identify Event</button>
      </div>
      
      <div class="form-group">
        <input type="text" id="page-name" placeholder="Page name" value="Test Page">
        <button onclick="sendPageEvent()">Send Page Event</button>
      </div>
      
      <div id="event-status" class="status" style="display: none;"></div>
    </div>

    <!-- Debug Information -->
    <div class="section">
      <h3>🔧 Debug Information</h3>
      <button onclick="showDebugInfo()">Show Debug Info</button>
      <button onclick="showIntegrations()">Show Loaded Integrations</button>
      <button onclick="openSegmentDebugger()">Open Segment Debugger</button>
      
      <div id="debug-info" class="debug-info" style="display: none;"></div>
    </div>
  </div>

  <script>
    // Simple state tracking
    let analyticsReady = false;
    let pluginsRegistered = false;
    
    // Plugin definitions (same as before)
    window.utmCampaignPersistencePlugin = () => {
      const STORAGE_KEY = 'segment_utm_campaign_source';
      const EXPIRY_DAYS = 30;
      
      const setLocalStorageWithExpiry = (key, value, days) => {
        try {
          const now = new Date();
          const item = {
            value: value,
            expiry: now.getTime() + (days * 24 * 60 * 60 * 1000),
          };
          localStorage.setItem(key, JSON.stringify(item));
        } catch (e) {
          console.warn('UTM Plugin: localStorage not available');
        }
      };
      
      const getLocalStorageWithExpiry = (key) => {
        try {
          const itemStr = localStorage.getItem(key);
          if (!itemStr) return null;
          
          const item = JSON.parse(itemStr);
          const now = new Date();
          
          if (now.getTime() > item.expiry) {
            localStorage.removeItem(key);
            return null;
          }
          
          return item.value;
        } catch (e) {
          return null;
        }
      };
      
      return {
        name: 'UTM Campaign Source Persistence',
        type: 'enrichment',
        version: '1.0.0',
        isLoaded: () => true,
        load: () => Promise.resolve(),
        
        page: (ctx) => {
          const currentCampaignSource = ctx.event.context?.campaign?.source;
          
          if (currentCampaignSource) {
            console.log(`UTM Plugin: Found campaign source: ${currentCampaignSource}`);
            setLocalStorageWithExpiry(STORAGE_KEY, currentCampaignSource, EXPIRY_DAYS);
          } else {
            const storedCampaignSource = getLocalStorageWithExpiry(STORAGE_KEY);
            if (storedCampaignSource) {
              console.log(`UTM Plugin: Adding stored campaign source: ${storedCampaignSource}`);
              ctx.updateEvent('context.campaign.source', storedCampaignSource);
            }
          }
          
          return ctx;
        },
        
        track: (ctx) => {
          const storedCampaignSource = getLocalStorageWithExpiry(STORAGE_KEY);
          if (storedCampaignSource && !ctx.event.context?.campaign?.source) {
            ctx.updateEvent('context.campaign.source', storedCampaignSource);
          }
          return ctx;
        },
        
        identify: (ctx) => {
          const storedCampaignSource = getLocalStorageWithExpiry(STORAGE_KEY);
          if (storedCampaignSource && !ctx.event.context?.campaign?.source) {
            ctx.updateEvent('context.campaign.source', storedCampaignSource);
          }
          return ctx;
        }
      };
    };

    window.geoLocationPlugin = (options = {}) => {
      const config = {
        timeout: options.timeout || 10000,
        debug: options.debug || false,
        autoRequestPermission: options.autoRequestPermission !== false
      };

      let locationData = null;

      const getIPLocationData = async () => {
        try {
          const response = await fetch('https://ipapi.co/json/');
          const data = await response.json();
          if (data.latitude && data.longitude) {
            return {
              latitude: parseFloat(data.latitude),
              longitude: parseFloat(data.longitude),
              city: data.city,
              region: data.region,
              country: data.country_name,
              source: 'ip'
            };
          }
        } catch (error) {
          console.warn('IP location failed', error);
        }
        return null;
      };

      const enrichEventWithLocation = (ctx) => {
        if (!locationData) return ctx;
        
        ctx.updateEvent('context.location', {
          latitude: locationData.latitude?.toString(),
          longitude: locationData.longitude?.toString(),
          city: locationData.city,
          region: locationData.region,
          country: locationData.country
        });
        
        return ctx;
      };

      return {
        name: 'Geo Location Tracking',
        type: 'enrichment',
        version: '1.0.0',
        
        isLoaded: () => true,
        
        load: async () => {
          if (config.autoRequestPermission) {
            locationData = await getIPLocationData();
          }
        },

        page: (ctx) => enrichEventWithLocation(ctx),
        track: (ctx) => enrichEventWithLocation(ctx),
        identify: (ctx) => enrichEventWithLocation(ctx)
      };
    };
    
    // Register plugins function (called from analytics.ready)
    async function registerPlugins() {
      try {
        // Register UTM Plugin
        await window.analytics.register(window.utmCampaignPersistencePlugin());
        console.log('✅ UTM Campaign Plugin registered');
        
        // Register Geo Plugin
        await window.analytics.register(window.geoLocationPlugin({ 
          debug: true,
          autoRequestPermission: true
        }));
        console.log('✅ Geo Location Plugin registered');
        
        pluginsRegistered = true;
        return true;
        
      } catch (error) {
        console.error('❌ Plugin registration failed:', error);
        throw error;
      }
    }
    
    // Update ready status in UI
    function updateReadyStatus() {
      analyticsReady = true;
      const statusEl = document.getElementById('ready-status');
      const integrations = Object.keys(window.analytics._integrations || {});
      
      statusEl.className = 'status success';
      statusEl.innerHTML = `✅ Analytics ready! Loaded ${integrations.length} destination SDKs: ${integrations.join(', ') || 'none'}`;
    }
    
    // UI Event Handlers
    function checkReadyStatus() {
      const statusEl = document.getElementById('ready-status');
      
      if (window.analytics.initialized) {
        const integrations = Object.keys(window.analytics._integrations || {});
        statusEl.className = 'status success';
        statusEl.innerHTML = `✅ Analytics initialized with ${integrations.length} integrations: ${integrations.join(', ') || 'none'}`;
      } else {
        statusEl.className = 'status warning';
        statusEl.innerHTML = '⏳ Still loading...';
      }
    }
    
    function checkPluginStatus() {
      const statusEl = document.getElementById('plugin-status');
      
      if (pluginsRegistered) {
        statusEl.className = 'status success';
        statusEl.innerHTML = '✅ All plugins registered successfully';
      } else if (analyticsReady) {
        statusEl.className = 'status warning';
        statusEl.innerHTML = '⏳ Analytics ready, plugins registering...';
      } else {
        statusEl.className = 'status info';
        statusEl.innerHTML = '⏳ Waiting for analytics to be ready...';
      }
    }
    
    function sendManualPageCall() {
      window.analytics.page('Manual Page Call', {
        manual: true,
        timestamp: new Date().toISOString()
      });
      updateStatus('ready-status', 'success', '📄 Manual page call sent');
    }
    
    function sendTrackEvent() {
      const eventName = document.getElementById('track-event').value || 'Button Clicked';
      window.analytics.track(eventName, {
        buttonId: 'test-button',
        timestamp: new Date().toISOString()
      });
      
      updateStatus('event-status', 'success', `✅ Sent track event: ${eventName}`);
    }
    
    function sendIdentifyEvent() {
      const userId = document.getElementById('user-id').value || 'test-user-123';
      const email = document.getElementById('user-email').value || 'test@example.com';
      
      window.analytics.identify(userId, {
        email: email,
        name: 'Test User',
        testTimestamp: new Date().toISOString()
      });
      
      updateStatus('event-status', 'success', `✅ Sent identify event for user: ${userId}`);
    }
    
    function sendPageEvent() {
      const pageName = document.getElementById('page-name').value || 'Test Page';
      window.analytics.page(pageName, {
        title: pageName,
        testTimestamp: new Date().toISOString()
      });
      
      updateStatus('event-status', 'success', `✅ Sent page event: ${pageName}`);
    }
    
    function showDebugInfo() {
      const debugInfo = {
        analyticsInitialized: window.analytics.initialized,
        analyticsReady: analyticsReady,
        pluginsRegistered: pluginsRegistered,
        loadedIntegrations: Object.keys(window.analytics._integrations || {}),
        userAgent: navigator.userAgent,
        currentUrl: window.location.href,
        timestamp: new Date().toISOString()
      };
      
      const element = document.getElementById('debug-info');
      element.innerHTML = '<pre>' + JSON.stringify(debugInfo, null, 2) + '</pre>';
      element.style.display = 'block';
    }
    
    function showIntegrations() {
      const integrations = window.analytics._integrations || {};
      const element = document.getElementById('debug-info');
      
      let html = '<h4>Loaded Destination Integrations:</h4>';
      
      if (Object.keys(integrations).length === 0) {
        html += '<p>No destination integrations loaded. This might be because:</p>';
        html += '<ul>';
        html += '<li>No destinations are configured in your Segment workspace</li>';
        html += '<li>All destinations are set to cloud-mode only</li>';
        html += '<li>Destinations are still loading</li>';
        html += '</ul>';
      } else {
        html += '<ul>';
        Object.entries(integrations).forEach(([name, integration]) => {
          html += `<li><strong>${name}</strong> - Ready: ${integration.ready || 'Unknown'}</li>`;
        });
        html += '</ul>';
      }
      
      element.innerHTML = html;
      element.style.display = 'block';
    }
    
    function openSegmentDebugger() {
      const writeKey = 'gmILwcgOaqputqVmLZKtD0eazHCAeNhR';
      window.open(`https://app.segment.com/sources/${writeKey}/debugger`, '_blank');
    }
    
    // Utility function to update status elements
    function updateStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      if (element) {
        element.className = `status ${type}`;
        element.innerHTML = message;
        element.style.display = 'block';
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
          setTimeout(() => {
            element.style.display = 'none';
          }, 5000);
        }
      }
    }
  </script>
</body>
</html>
